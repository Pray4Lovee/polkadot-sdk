name: Build & Push ETH-RPC Image
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  packages: write
  security-events: write
  attestations: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  ETH_RPC_IMAGE_NAME: docker.io/paritypr/eth-rpc
  PLATFORMS: linux/amd64,linux/arm64
  DOCKERFILE: ./substrate/frame/revive/rpc/dockerfiles/eth-rpc/Dockerfile

jobs:
  # ── Microlayer 01: Draft PR Early Exit ──
  isdraft:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/reusable-isdraft.yml

  # ── Microlayer 02: Semantic Versioning & Tagging Strategy ──
  set-variables:
    runs-on: ubuntu-latest
    needs: isdraft
    if: needs.isdraft.outputs.is_draft == 'false' || github.event_name != 'pull_request'
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      SHORT_SHA: ${{ steps.version.outputs.SHORT_SHA }}
      TAG_LATEST: ${{ steps.version.outputs.TAG_LATEST }}
    steps:
      - name: Calculate advanced version
        id: version
        run: |
          SHORT_SHA=${{ github.sha }} | cut -c1-8
          if [[ ${{ github.ref }} == refs/heads/master ]]; then
            VERSION=latest
            TAG_LATEST=true
          elif [[ ${{ github.ref_type }} == tag ]]; then
            VERSION=${{ github.ref_name }}
            TAG_LATEST=false
          else
            BRANCH_SLUG=$(echo ${{ github.ref_name }} | tr '/' '_' | tr '[:upper:]' '[:lower:]')
            VERSION=${BRANCH_SLUG}-${SHORT_SHA}
            TAG_LATEST=false
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "TAG_LATEST=$TAG_LATEST" >> $GITHUB_OUTPUT

  # ── Microlayer 03: Global Cache Key Generation ──
  cache-keys:
    runs-on: ubuntu-latest
    needs: set-variables
    outputs:
      cargo_key: ${{ steps.key.outputs.cargo }}
      docker_key: ${{ steps.key.outputs.docker }}
    steps:
      - name: Generate cache keys
        id: key
        run: |
          echo "cargo=cargo-v1-${{ hashFiles('**/Cargo.lock') }}" >> $GITHUB_OUTPUT
          echo "docker=docker-v1-${{ hashFiles(env.DOCKERFILE, '**/Cargo.lock') }}-${{ needs.set-variables.outputs.SHORT_SHA }}" >> $GITHUB_OUTPUT

  # ── Microlayer 04: Repository Checkout with Full History ──
  checkout:
    runs-on: ubuntu-latest
    needs: set-variables
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

  # ── Microlayer 05: Rust Toolchain Cache (per-version) ──
  rust-cache:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Cache Cargo registry + target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ needs.cache-keys.outputs.cargo_key }}
          restore-keys: |
            ${{ needs.cache-keys.outputs.cargo_key }}

  # ── Microlayer 06: Security Advisory & Dependency Checks ──
  cargo-security:
    runs-on: ubuntu-latest
    needs: rust-cache
    strategy:
      matrix:
        tool: [deny, audit, outlaw]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run cargo-${{ matrix.tool }}
        run: |
          cargo install cargo-${{ matrix.tool }} --locked
          cargo ${{ matrix.tool }} check

  # ── Microlayer 07: Code Quality Matrix (fmt/clippy/docs) ──
  quality-gate:
    runs-on: ubuntu-latest
    needs: cargo-security
    strategy:
      matrix:
        check: [rustfmt, clippy, docs]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy
      - name: ${{ matrix.check }}
        run: |
          if [[ "${{ matrix.check }}" == "rustfmt" ]]; then
            cargo +nightly fmt --all -- --check
          elif [[ "${{ matrix.check }}" == "clippy" ]]; then
            cargo +nightly clippy --all-targets --all-features -- -D warnings
          else
            RUSTDOCFLAGS="-D warnings" cargo +nightly doc --all-features --no-deps --document-private-items
          fi

 # ── Microlayer 08: Rust Multi-Version Compatibility Matrix ──
rust-matrix:
  runs-on: parity-large
  needs: quality-gate
  strategy:
    fail-fast: false
    matrix:
      rust: [1.71.0, stable, beta, nightly]
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust ${{ matrix.rust }}
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        rustup install ${{ matrix.rust }}
        rustup override set ${{ matrix.rust }}
        rustc --version
        cargo --version

    - name: Restore Cargo cache for ${{ matrix.rust }}
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ needs.cache-keys.outputs.cargo_key }}-${{ matrix.rust }}

    - name: Check & Unit Tests
      run: |
        cargo check --all-features --all-targets
        cargo test --all-features -- --nocapture --test-threads=8

  # ── Microlayer 09: Buildx Setup & Multi-Arch Cache ──
  buildx-setup:
    runs-on: parity-large
    needs: rust-matrix
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Cache Docker layers (GHA backend)
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ needs.cache-keys.outputs.docker_key }}
          restore-keys: ${{ needs.cache-keys.outputs.docker_key }}

  # ── Microlayer 10: Multi-Arch Docker Build + SBOM + Provenance ──
  docker-build:
    runs-on: parity-large
    needs: buildx-setup
    env:
      VERSION: ${{ needs.set-variables.outputs.VERSION }}
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.PARITYPR_DOCKERHUB_USERNAME }}
          password: ${{ secrets.PARITYPR_DOCKERHUB_PASSWORD }}
      - name: Build & Push Multi-Arch Microlayer Image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: ${{ env.PLATFORMS }}
          push: ${{ github.ref == 'refs/heads/master' }}
          tags: |
            ${{ env.ETH_RPC_IMAGE_NAME }}:${{ env.VERSION }}
            ${{ needs.set-variables.outputs.TAG_LATEST == 'true' && env.ETH_RPC_IMAGE_NAME || '' }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true
          outputs: type=image,name=${{ env.ETH_RPC_IMAGE_NAME }},push-by-digest=true

  # ── Microlayer 11: Vulnerability Scanning + SARIF Upload ──
  trivy-scan:
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ETH_RPC_IMAGE_NAME }}:${{ needs.set-variables.outputs.VERSION }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

  # ── Microlayer 12: Keyless Signing + Vulnerability Attestation ──
  sign-attest:
    runs-on: ubuntu-latest
    needs: trivy-scan
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@main
      - name: Sign & Attest
        env:
          DIGEST: ${{ needs.docker-build.outputs.digest }}
        run: |
          cosign sign --yes ${{ env.ETH_RPC_IMAGE_NAME }}@${DIGEST}
          cosign attest --yes --type vuln --predicate trivy-results.sarif ${{ env.ETH_RPC_IMAGE_NAME }}@${DIGEST}

  # ── Microlayer 13: Full E2E Matrix with Flake-Resistant Retries ──
  e2e-tests:
    runs-on: parity-large
    needs: docker-build
    strategy:
      fail-fast: false
      matrix:
        node: [dev, kitchensink, westend, polkadot, localnet]
        attempt: [1, 2]
    continue-on-error: ${{ matrix.attempt == 2 }}
    steps:
      - name: Run E2E ${{ matrix.node }} (attempt ${{ matrix.attempt }})
        run: |
          docker pull ${{ env.ETH_RPC_IMAGE_NAME }}:${{ needs.set-variables.outputs.VERSION }}
          docker run --rm -e NODE=${{ matrix.node }} \
            ${{ env.ETH_RPC_IMAGE_NAME }}:${{ needs.set-variables.outputs.VERSION }} \
            sh -c "./tests/run_integration_tests.sh --node $NODE || exit 1"
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-${{ matrix.node }}-attempt-${{ matrix.attempt }}
          path: tests/logs/*

  # ── Microlayer 14: Flake Detection & Auto-Fail on Persistent Failure ──
  flake-detection:
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    steps:
      - uses: actions/download-artifact@v4
      - name: Detect persistent failures
        run: |
          if grep -r "FAIL" . | grep -v attempt-2; then
            echo "Persistent test failures detected"
            exit 1
          else
            echo "All tests passed (with retries where needed)"
          fi

  # ── Microlayer 15: Ephemeral Canary Deployment for PRs ──
  canary-deploy:
    runs-on: parity-large
    needs: e2e-tests
    if: github.event_name == 'pull_request'
    steps:
      - name: Deploy PR canary
        run: |
          docker run --rm -e NODE=canary -e PR=${{ github.event.pull_request.number }} \
            ${{ env.ETH_RPC_IMAGE_NAME }}:${{ needs.set-variables.outputs.VERSION }} \
            sh -c "./scripts/canary_deploy.sh"

  # ── Microlayer 16: Final Notification with Full Context ──
  notify:
    runs-on: ubuntu-latest
    needs: [docker-build, sign-attest, flake-detection, canary-deploy]
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "ETH-RPC Image: ${{ env.ETH_RPC_IMAGE_NAME }}:${{ needs.set-variables.outputs.VERSION }}"
          echo "Status: ${{ job.status }}"
          echo "Multi-arch, SBOM-generated, signed, attested, zero persistent E2E failures"
