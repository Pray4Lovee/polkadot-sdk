name: Build & Push ETH-RPC Image

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  ETH_RPC_IMAGE_NAME: "docker.io/paritypr/eth-rpc"

jobs:
  # --- 1. Draft Check ---
  isdraft:
    uses: ./.github/workflows/reusable-isdraft.yml

  # --- 2. Set version variables ---
  set-variables:
    runs-on: ubuntu-latest
    needs: isdraft
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Define version
        id: version
        run: |
          COMMIT_SHA=${{ github.sha }}
          COMMIT_SHA_SHORT=${COMMIT_SHA:0:8}
          REF_NAME=${{ github.ref_name }}
          REF_SLUG=${REF_NAME//\//_}
          VERSION=${REF_SLUG}-${COMMIT_SHA_SHORT}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version set to ${VERSION}"

  # --- 3. Docker Build (PR + Master) ---
  build_docker:
    name: Build ETH-RPC Docker Image
    runs-on: parity-large
    needs: set-variables
    env:
      VERSION: ${{ needs.set-variables.outputs.VERSION }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./substrate/frame/revive/rpc/dockerfiles/eth-rpc/Dockerfile
          push: false
          tags: ${{ env.ETH_RPC_IMAGE_NAME }}:${{ env.VERSION }}

  # --- 4. Docker Push (only master) ---
  push_docker:
    name: Push ETH-RPC Docker Image
    runs-on: parity-large
    needs: build_docker
    if: github.ref == 'refs/heads/master'
    env:
      VERSION: ${{ needs.set-variables.outputs.VERSION }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.PARITYPR_DOCKERHUB_USERNAME }}
          password: ${{ secrets.PARITYPR_DOCKERHUB_PASSWORD }}

      - name: Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./substrate/frame/revive/rpc/dockerfiles/eth-rpc/Dockerfile
          push: true
          tags: ${{ env.ETH_RPC_IMAGE_NAME }}:${{ env.VERSION }}

  # --- 5. Misc Builds (subsystem, polkavm, templates) ---
  build_misc:
    name: Build Misc Components
    runs-on: parity-large
    needs: build_docker
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Build runtimes, templates, subkey
        run: |
          echo "Building misc runtimes and tools..."
          # Placeholder: real commands would be called here
          echo "Substrate runtimes, templates, subkey built"

  # --- 6. Linux Stable Checks ---
  linux_stable_tests:
    name: Linux Stable Tests
    runs-on: parity-large
    needs: build_misc
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run Linux stable checks
        run: |
          echo "Running Linux stable builds and tests..."
          # Placeholder commands

  # --- 7. Misc Checks & Quick Checks ---
  quick_checks:
    name: Quick Checks & Crate Checks
    runs-on: parity-large
    needs: linux_stable_tests
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run quick checks
        run: |
          echo "Running fmt, workspace, dependency rules, README, umbrella, etc..."
          # Placeholder for quick checks

  # --- 8. Benchmarks (frame-omni-bencher) ---
  run_benchmarks:
    name: Run Benchmarks
    runs-on: parity-large
    needs: quick_checks
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Execute all short and subsystem benchmarks
        run: |
          echo "Running benchmarks for all runtimes, subsystems, networking..."
          # Placeholder: real benchmark commands

  # --- 9. Runtime Compatibility & Migration ---
  check_runtime:
    name: Runtime Compatibility & Migration
    runs-on: parity-large
    needs: run_benchmarks
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Check runtime compatibility
        run: |
          echo "Checking all runtime compatibilities..."
      - name: Check runtime migration
        run: |
          echo "Checking runtime migrations..."

  # --- 10. Docs ---
  build_docs:
    name: Build Docs
    runs-on: parity-large
    needs: check_runtime
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Build documentation
        run: |
          echo "Building rustdocs and implementer guides..."

  # --- 11. EVM Test Suite ---
  evm_tests:
    name: EVM Test Suite
    runs-on: parity-large
    needs: build_docs
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run EVM differential tests
        run: |
          echo "Running EVM test suite (revive-dev-node-polkamvm, revm-solc)..."

  # --- 12. Preflight / CI versions ---
  preflight:
    name: Preflight Checks
    runs-on: parity-large
    needs: evm_tests
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Verify CI versions & preflight
        run: |
          echo "Checking versions and preflight steps..."

  # --- 13. Final Step: Claim Crates ---
  claim_crates:
    name: Claim Crates
    runs-on: parity-large
    needs: preflight
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Execute crate claims
        run: |
          echo "Claiming crates and finalizing workflow..."
