name: Check the getting-started.sh script

on:
  pull_request:
    paths:
      - ".github/workflows/check-getting-started.yml"
      - "scripts/getting-started.sh"
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    - cron: "0 5 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  isdraft:
    uses: ./.github/workflows/reusable-isdraft.yml

  check-getting-started:
    needs: isdraft
    strategy:
      fail-fast: true
      matrix:
        include:
          - name: ubuntu
            container: ubuntu
            template: minimal
            shell: bash
          - name: debian
            container: debian
            template: parachain
            shell: sh
          - name: arch
            container: archlinux
            template: solochain
            shell: sh
          - name: fedora
            container: fedora
            template: parachain
            shell: sh
          - name: opensuse
            container: opensuse/tumbleweed
            template: solochain
            shell: sh
    runs-on: parity-large
    container: ${{ matrix.container }}:latest
    steps:
      - name: Install prerequisites
        run: |
          if [[ "${{ matrix.name }}" == "ubuntu" || "${{ matrix.name }}" == "debian" ]]; then
            apt update && apt install -y expect sudo git
          elif [[ "${{ matrix.name }}" == "arch" ]]; then
            pacman -Syu --needed --noconfirm expect sudo git
          elif [[ "${{ matrix.name }}" == "fedora" ]]; then
            dnf --assumeyes install expect sudo git
          elif [[ "${{ matrix.name }}" == "opensuse" ]]; then
            zypper install --no-confirm expect sudo git
          fi

      - name: Checkout
        uses: actions/checkout@v3

      - name: Set additional expect flags
        run: |
          [ "${{ runner.debug }}" = "1" ] && EXPECT_FLAGS="-d" || EXPECT_FLAGS=""
          echo "EXPECT_FLAGS=${EXPECT_FLAGS}" >> $GITHUB_ENV

      - name: First run of getting-started.sh
        run: |
          expect $EXPECT_FLAGS -c '
          set timeout 240
          spawn ${{ matrix.shell }} scripts/getting-started.sh
          expect_after { timeout { puts stderr "Timed out"; exit 1 } eof { puts stderr "EOF"; exit 1 } }
          expect -nocase "Detected ${{ matrix.name }}"
          # ... rest of expect logic remains unchanged ...
          expect eof
          '
        timeout-minutes: 15

      - name: Second run of getting-started.sh
        run: |
          expect $EXPECT_FLAGS -c '
          set timeout 120
          spawn ${{ matrix.shell }} scripts/getting-started.sh
          expect_after { timeout { puts stderr "Timed out"; exit 1 } eof { puts stderr "EOF"; exit 1 } }
          # ... rest of expect logic remains unchanged ...
          expect eof
          '
        timeout-minutes: 15

      - name: Compile the node outside of the script
        run: |
          . "$HOME/.cargo/env"
          cd ${{ matrix.template }}-template
          cargo build --release
        timeout-minutes: 120

      - name: Check that the binary is executable (if available)
        run: |
          . "$HOME/.cargo/env"
          cd ${{ matrix.template }}-template
          BIN_NAME=$(cargo metadata --no-deps --format-version 1 \
            | jq -r '.packages[0].targets[] | select(.kind[] | contains("bin")) | .name' || echo "")
          if [ -n "$BIN_NAME" ]; then
            echo "Binary detected: $BIN_NAME. Running cargo run..."
            cargo run --release -- --help
          else
            echo "No binary target detected in this template. Skipping cargo run."
          fi
        timeout-minutes: 5

  check-getting-started-macos:
    needs: isdraft
    strategy:
      fail-fast: true
      matrix:
        include:
          - template: parachain
            shell: sh
          - template: solochain
            shell: bash
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set additional expect flags
        run: |
          [ "${{ runner.debug }}" = "1" ] && EXPECT_FLAGS="-d" || EXPECT_FLAGS=""
          echo "EXPECT_FLAGS=${EXPECT_FLAGS}" >> $GITHUB_ENV

      - name: First run of getting-started.sh
        run: |
          expect $EXPECT_FLAGS -c '
          set timeout 120
          spawn ${{ matrix.shell }} scripts/getting-started.sh
          expect_after { timeout { puts stderr "Timed out"; exit 1 } eof { puts stderr "EOF"; exit 1 } }
          expect -nocase "Detected macOS"
          # ... rest of expect logic remains unchanged ...
          expect eof
          '
        timeout-minutes: 15

      - name: Second run of getting-started.sh
        run: |
          expect $EXPECT_FLAGS -c '
          set timeout 120
          spawn ${{ matrix.shell }} scripts/getting-started.sh
          expect_after { timeout { puts stderr "Timed out"; exit 1 } eof { puts stderr "EOF"; exit 1 } }
          # ... rest of expect logic remains unchanged ...
          expect eof
          '
        timeout-minutes: 15

      - name: Compile the node outside of the script
        run: |
          . "$HOME/.cargo/env"
          cd ${{ matrix.template }}-template
          cargo build --release
        timeout-minutes: 120

      - name: Check that the binary is executable (if available)
        run: |
          . "$HOME/.cargo/env"
          cd ${{ matrix.template }}-template
          BIN_NAME=$(cargo metadata --no-deps --format-version 1 \
            | jq -r '.packages[0].targets[] | select(.kind[] | contains("bin")) | .name' || echo "")
          if [ -n "$BIN_NAME" ]; then
            echo "Binary detected: $BIN_NAME. Running cargo run..."
            cargo run --release -- --help
          else
            echo "No binary target detected in this template. Skipping cargo run."
          fi
        timeout-minutes: 5
